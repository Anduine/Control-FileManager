<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">

  <Style TargetType="Menu">
    <Setter Property="Background" Value="{DynamicResource PanelBgColor}"/>
    <Setter Property="Foreground" Value="{DynamicResource TextColor}"/>
    <Setter Property="BorderBrush" Value="{DynamicResource BorderColor}"/>
    <Setter Property="BorderThickness" Value="0,0,0,1"/>
    <Setter Property="Padding" Value="4"/>
  </Style>

  <Style x:Key="BaseMenuItemStyle" TargetType="MenuItem">
    <Setter Property="Foreground" Value="{DynamicResource TextColor}"/>
    <Setter Property="Background" Value="Transparent"/>
    <Setter Property="BorderBrush" Value="Transparent"/>
    <Setter Property="BorderThickness" Value="1"/>
    <Setter Property="Padding" Value="6,4"/>

    <Setter Property="Template">
      <Setter.Value>
        <ControlTemplate TargetType="MenuItem">
          <Grid>

            <Border x:Name="templateRoot" 
                    Background="{TemplateBinding Background}" 
                    BorderBrush="{TemplateBinding BorderBrush}" 
                    BorderThickness="{TemplateBinding BorderThickness}" 
                    SnapsToDevicePixels="true"
                    Margin="1">

              <Grid VerticalAlignment="Center">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="Auto" SharedSizeGroup="Icon"/>
                  <ColumnDefinition Width="*"/>
                  <ColumnDefinition Width="Auto" SharedSizeGroup="Shortcut"/>
                  <ColumnDefinition Width="13"/>
                </Grid.ColumnDefinitions>

                <ContentPresenter x:Name="Icon" 
                                  Content="{TemplateBinding Icon}" 
                                  ContentSource="Icon" 
                                  Width="16" Height="16" Margin="3" 
                                  SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" 
                                  HorizontalAlignment="Center" VerticalAlignment="Center"/>

                <Border x:Name="Check" 
                        Background="{DynamicResource SelectionColor}" 
                        BorderThickness="1" 
                        BorderBrush="{DynamicResource SelectionColor}" 
                        Visibility="Collapsed" 
                        Margin="4,0,6,0" Width="16" Height="16" CornerRadius="2">
                  <Path Data="M 0,5 L 3,8 L 8,0" Stroke="White" StrokeThickness="2" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                </Border>

                <ContentPresenter x:Name="HeaderHost" 
                                  Grid.Column="1" 
                                  Content="{TemplateBinding Header}" 
                                  ContentTemplate="{TemplateBinding HeaderTemplate}"
                                  ContentStringFormat="{TemplateBinding HeaderStringFormat}" 
                                  ContentSource="Header" 
                                  Margin="{TemplateBinding Padding}" 
                                  RecognizesAccessKey="True" 
                                  SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" 
                                  VerticalAlignment="Center"/>

                <TextBlock x:Name="InputGestureText" 
                            Grid.Column="2" 
                            Text="{TemplateBinding InputGestureText}" 
                            Foreground="{DynamicResource TextDisabledColor}" 
                            Margin="15,2,0,2" 
                            VerticalAlignment="Center"
                            DockPanel.Dock="Right"/>

                <Path x:Name="RightArrow" 
                      Grid.Column="3" 
                      Data="M0,0 L4,3.5 L0,7 Z" 
                      Fill="{DynamicResource TextColor}" 
                      Margin="4,0,0,0" 
                      VerticalAlignment="Center" 
                      Visibility="Collapsed"/>
              </Grid>
            </Border>

            <Popup x:Name="Popup" 
                    IsOpen="{Binding IsSubmenuOpen, RelativeSource={RelativeSource TemplatedParent}}" 
                    Placement="Right" 
                    HorizontalOffset="1" 
                    VerticalOffset="-1"
                    AllowsTransparency="true" 
                    Focusable="false" 
                    PopupAnimation="{DynamicResource {x:Static SystemParameters.MenuPopupAnimationKey}}">

              <Border x:Name="SubMenuBorder" 
                      Background="{DynamicResource PanelBgColor}" 
                      BorderBrush="{DynamicResource BorderColor}" 
                      BorderThickness="1" 
                      Padding="2">

                <ScrollViewer Style="{DynamicResource {ComponentResourceKey ResourceId=MenuScrollViewer, TypeInTargetAssembly={x:Type FrameworkElement}}}">
                  <Grid RenderOptions.ClearTypeHint="Enabled">
                    <Canvas HorizontalAlignment="Left" Height="0" VerticalAlignment="Top" Width="0">
                      <Rectangle Fill="{DynamicResource PanelBgColor}" Height="{Binding ActualHeight, ElementName=SubMenuBorder}" Width="{Binding ActualWidth, ElementName=SubMenuBorder}"/>
                    </Canvas>
                    <ItemsPresenter x:Name="ItemsPresenter" KeyboardNavigation.DirectionalNavigation="Contained" Grid.IsSharedSizeScope="true" SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                  </Grid>
                </ScrollViewer>
              </Border>
            </Popup>

          </Grid>
          <ControlTemplate.Triggers>

            <Trigger Property="Role" Value="TopLevelHeader">
              <Setter Property="Padding" Value="7,5"/>
              <Setter TargetName="Popup" Property="Placement" Value="Bottom"/>
              <Setter TargetName="Popup" Property="VerticalOffset" Value="0"/>
              <Setter TargetName="SubMenuBorder" Property="Background" Value="{DynamicResource PanelBgColor}"/>
            </Trigger>

            <Trigger Property="Role" Value="TopLevelItem">
              <Setter Property="Padding" Value="7,5"/>
            </Trigger>

            <Trigger Property="Role" Value="SubmenuHeader">
              <Setter TargetName="RightArrow" Property="Visibility" Value="Visible"/>
            </Trigger>

            <Trigger Property="IsHighlighted" Value="True">
              <Setter TargetName="templateRoot" Property="Background" Value="{DynamicResource HoverColor}"/>
              <Setter TargetName="templateRoot" Property="BorderBrush" Value="{DynamicResource BorderColor}"/>
            </Trigger>

            <Trigger Property="IsEnabled" Value="False">
              <Setter Property="Foreground" Value="{DynamicResource TextDisabledColor}"/>
              <Setter TargetName="Icon" Property="Opacity" Value="0.5"/>
              <Setter TargetName="RightArrow" Property="Opacity" Value="0.5"/>
              <Setter TargetName="InputGestureText" Property="Opacity" Value="0.5"/>
            </Trigger>

            <Trigger Property="IsChecked" Value="True">
              <Setter TargetName="Check" Property="Visibility" Value="Visible"/>
              <Setter TargetName="Icon" Property="Visibility" Value="Collapsed"/>
            </Trigger>

          </ControlTemplate.Triggers>
        </ControlTemplate>
      </Setter.Value>
    </Setter>
  </Style>

  <Style TargetType="MenuItem" BasedOn="{StaticResource BaseMenuItemStyle}"/>

  <Style TargetType="Separator">
    <Setter Property="Background" Value="{DynamicResource BorderColor}"/>
    <Setter Property="Margin" Value="0,4"/>
    <Setter Property="Focusable" Value="False"/>
  </Style>

  <Style x:Key="ContextMenuStyle" TargetType="ContextMenu">
    <Setter Property="OverridesDefaultStyle" Value="True"/>
    <Setter Property="Background" Value="{DynamicResource PanelBgColor}"/>
    <Setter Property="Foreground" Value="{DynamicResource TextColor}"/>
    <Setter Property="BorderBrush" Value="{DynamicResource BorderColor}"/>
    <Setter Property="BorderThickness" Value="1"/>
    <Setter Property="Grid.IsSharedSizeScope" Value="True"/>
    
    <Setter Property="Template">
      <Setter.Value>
        <ControlTemplate TargetType="ContextMenu">
          <Border Background="{TemplateBinding Background}" 
                  BorderBrush="{TemplateBinding BorderBrush}" 
                  BorderThickness="{TemplateBinding BorderThickness}">
            <ItemsPresenter/>
          </Border>
        </ControlTemplate>
      </Setter.Value>
    </Setter>
  </Style>

  <Style x:Key="ContextMenuItemStyle" TargetType="MenuItem">
    <Setter Property="OverridesDefaultStyle" Value="True"/>
    <Setter Property="Foreground" Value="{DynamicResource BorderColor}"/>
    <Setter Property="Background" Value="{DynamicResource HoverColor}"/>
    <Setter Property="BorderBrush" Value="Transparent"/>
    <Setter Property="BorderThickness" Value="1"/>
    <Setter Property="Padding" Value="4,6"/>
    <Setter Property="Template">
      <Setter.Value>
        <ControlTemplate TargetType="MenuItem">
          <Border x:Name="templateRoot" 
                  Background="{TemplateBinding Background}" 
                  BorderBrush="{TemplateBinding BorderBrush}" 
                  BorderThickness="{TemplateBinding BorderThickness}" 
                  SnapsToDevicePixels="true">

            <Grid VerticalAlignment="Center">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" SharedSizeGroup="Icon"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto" SharedSizeGroup="Shortcut"/>
                <ColumnDefinition Width="13"/>
              </Grid.ColumnDefinitions>

              <ContentPresenter x:Name="Icon" 
                                Content="{TemplateBinding Icon}" 
                                ContentSource="Icon" 
                                Width="16" Height="16" 
                                Margin="3" 
                                SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" 
                                HorizontalAlignment="Center" VerticalAlignment="Center"/>

              <ContentPresenter x:Name="HeaderHost" 
                                Grid.Column="1" 
                                Content="{TemplateBinding Header}" 
                                ContentTemplate="{TemplateBinding HeaderTemplate}"
                                ContentStringFormat="{TemplateBinding HeaderStringFormat}" 
                                ContentSource="Header" 
                                Margin="{TemplateBinding Padding}" 
                                RecognizesAccessKey="True" 
                                SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" 
                                VerticalAlignment="Center"/>

              <TextBlock x:Name="InputGestureText" 
                         Grid.Column="2" 
                         DockPanel.Dock="Right"
                         Text="{TemplateBinding InputGestureText}" 
                         Foreground="{DynamicResource TextDisabledColor}" 
                         Margin="15,2,0,2" 
                         VerticalAlignment="Center"/>
            </Grid>
          </Border>

          <ControlTemplate.Triggers>
            <Trigger Property="IsHighlighted" Value="True">
              <Setter TargetName="templateRoot" Property="Background" Value="{DynamicResource HoverColor}"/>
              <Setter TargetName="templateRoot" Property="BorderBrush" Value="{DynamicResource BorderColor}"/>
            </Trigger>

            <Trigger Property="IsEnabled" Value="False">
              <Setter TargetName="InputGestureText" Property="Foreground" Value="{DynamicResource TextDisabledColor}"/>
              <Setter TargetName="Icon" Property="Opacity" Value="0.5"/>
            </Trigger>

            <Trigger Property="IsPressed" Value="True">
              <Setter TargetName="templateRoot" Property="Background" Value="{DynamicResource SelectionColor}"/>
              <Setter TargetName="InputGestureText" Property="Background" Value="{DynamicResource SelectionColor}"/>
            </Trigger>
          </ControlTemplate.Triggers>
        </ControlTemplate>
      </Setter.Value>
    </Setter>
  </Style>

</ResourceDictionary>